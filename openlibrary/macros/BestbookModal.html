$def with (work, link_markup, id, award, classes='', reload_id=None, edition_key=None)
$# :param Work work: The work that is being reviewed
$# :param str link_markup: arkup for element that triggers observations modal
$# :param str id: Unique identifier for this modal
$# :param str classes: HTML classes for this component
$# :param str reload_id: Reference to UI component that will update when observations are added or removed

$ topics = work.get_subjects()
$ username = ctx.user and ctx.user.key.split('/')[-1]
$# The following data is accessed via JS:
$ context = {
  $ "username": username,
  $ "work": work.key,
  $ "id": id
  $ }

$ users_work_read_status = get_patrons_work_read_status(username, work.key) if work and username else None

$if reload_id:
  $ context['reloadId'] = reload_id

$# show edition cover if edition, else if work cover for work
$ work_key = work.key
$ src = '/images/icons/avatar_book.png'

$ work_id = ""
$ edition_id = ""

$if edition_key:
  $ edition_id = edition_key.split('/')[-1]
  $ src = "https://covers.openlibrary.org/b/olid/{}-M.jpg".format(edition_id)
$elif work_key:
  $ work_id = work_key.split('/')[-1]
  $ src = "https://covers.openlibrary.org/w/olid/{}-M.jpg".format(work_id)

$if any(work.get_authors()):
  $ author_names = ", ".join(a.get("name", "Name missing") for a in work.get_authors())

$ default_comment = award['comment'] if award else ""
$ default_topic = award['topic'] if award else ""

$# Render the subject input field
$jsdef render_subject_field_bestbook(name, data):
    <div class="input">
        $code:
            subject_str = data if len(data) else ""
        <input name="topic" placeholder="$default_topic" wrap="soft" value="$subject_str" />
    </div>

$jsdef render_subject_autocomplete_item(item):
    <div class="ac_subject" title="$_('Select this subject')">
        <span class="name">$item.label</span>
    </div>

<div class="$classes">
  $:link_markup
  $if ctx.user:
    <div class="hidden">
      <div id="$id-metadata-form" class="metadata-form bestbook-modal" data-context="$json_encode(context)">
        <div class="floaterHead">
          <h2>$_("Best Book Award")</h2>
          <a class="dialog--close">&times;<span class="shift">$_("Close")</span></a>
        </div>
        <div class="bestbook_info">
          If you’ve read a book and believe it’s the best book on a topic, you may give it a best book award! Choose carefully because you may only nominate 1 book per topic
        </div>
        <div class="bestbook_body">
          <div class="bestbook_data">
            <h3>$work.title</h3>
            <img src="$src" class="bestbook-img" alt="Cover of: $(work.title)">
            <p>$author_names</p>
          </div>
          <form id="ratingsForm" method="POST" action="$(work.key)/awards.json" vocab="http://schema.org/" typeof="Books" class="bestbook">
            <label for="topic">$_("On what topic?")</label>

            $ config = {'name': 'topics', 'facet': 'subject', 'work_key': work_key, 'data': default_topic if default_topic else ''}

            <div class="csv-autocomplete--book-subject" data-config="$dumps(config)">
                $:render_subject_field_bestbook(config['name'], config['data'])
            </div>

            <input type="hidden" value="true" name="redir">
            <input type="hidden" value="$edition_key" name="edition_key">

            <label for="comment">$_("Why?")</label>
            <textarea name="comment" rows="3" placeholder=$_("Comment") cols="80">$default_comment</textarea>

            <button class="bestbook_submit" type="submit">$_("Submit")</button>
            $if users_work_read_status != 3:
              <div class="bestbook_warning">⚠️ $_("Awards may only be given to books you have already read. Submitting this award will mark this book as \"Already Read\"")
              </div>
          </form>
        </div>

        $if award:
          <div>
            <form action="$(work.key)/awards.json" method="POST">
              <input type="hidden" value="true" name="redir">
              <button class="cta-btn cta-btn--delete bestbook-remove-button" type="submit">$_("Remove Award")</button>
            </form>
          </div>
      </div>
    </div>
</div>
